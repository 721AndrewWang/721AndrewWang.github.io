<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CALL Blog</title>
    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="../../styles.css" />
    <style>
      /* ‰ΩøÁî®Êõ¥Áé∞‰ª£ÁöÑCSSÂèòÈáèÁ≥ªÁªü */
      :root {
        --primary-color: #2b6cb0;
        --background-color: #fff;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --text-color: #2b2b2b;
        --border-radius: 12px;
      }

      .H5P-container {
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 2px 8px var(--shadow-color);
        margin: 0;
        width: 100%;
        max-width: 700px;
        padding: 0;
        position: relative;
        flex: 1;
        min-width: 300px;
        background: var(--background-color);
      }
      
      .H5P-iframe {
        border: none;
        width: 100%;
        min-height: 800px;
        height: 800px;
        display: block;
        z-index: 1;
        position: relative;
        background-color: var(--background-color);
        overflow: hidden;
      }

      /* ÁßªÈô§ÈÅÆÁΩ©Â±Ç */
      .iframe-overlay {
        display: none;
      }

      .page-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 100%;
        max-width: 1600px;
        margin: 0 auto;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        text-align: center;
        margin-bottom: 20px;
      }

      .center {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        text-align: center;
        padding: 40px 20px;
        margin-bottom: 0;
      }

      .center h1 {
        font-size: 2.5em;
        margin: 0;
        padding: 0;
        color: #2b2b2b;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .exercise-instruction {
        width: 100%;
        text-align: center;
        margin: 1.5em auto;
        color: #666;
        font-size: 1.1em;
        line-height: 1.6;
        max-width: 800px;
      }

      .exercise-navigation {
        display: flex;
        justify-content: center;
        margin: 2em 0;
        padding: 0 20px;
      }
      
      /* Ê∑ªÂä†ÂØºËà™ÊåâÈíÆÊ†∑Âºè */
      .nav-button {
        display: inline-block;
        padding: 8px 16px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        color: #2b6cb0;
        text-decoration: none;
        font-size: 1em;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .nav-button:hover {
        background-color: #2b6cb0;
        color: white;
        transform: translateY(-2px);
      }

      /* GEC-ASR ÂäüËÉΩÊ†∑Âºè */
      .gec-asr-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 700px; /* ÂáèÂ∞èÂÆΩÂ∫¶‰ª•ÈÄÇÂ∫îÂπ∂Êéí */
        text-align: center;
        background: rgba(255, 255, 255, 0.98);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin: 0; /* Ë∞ÉÊï¥ËæπË∑ù */
        flex: 1; /* ÂºπÊÄßÂ∏ÉÂ±Ä */
        min-width: 300px; /* ÊúÄÂ∞èÂÆΩÂ∫¶ÔºåÈÅøÂÖçÂ§™Á™Ñ */
      }

      .gec-asr-container h2 {
        color: #2b6cb0;
        margin-bottom: 20px;
        width: 100%;
        text-align: center;
      }

      .gec-asr-container p {
        color: #4a5568;
        line-height: 1.6;
        margin-bottom: 20px;
      }

      button {
        padding: 12px 24px;
        font-size: 16px;
        margin: 10px 5px;
        cursor: pointer;
        background-color: #2b6cb0;
        color: white;
        border: none;
        border-radius: 25px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      pre, .output {
        background: rgba(255, 255, 255, 0.98);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        text-align: left;
        white-space: pre-wrap;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        width: 100%;
        max-width: 700px;
      }

      mark {
        background-color: #ffeb3b;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
      }

      .output strong {
        color: #2b6cb0;
        display: block;
        margin-top: 15px;
      }

      .section-divider {
        width: 100%;
        max-width: 800px;
        margin: 30px auto;
        height: 2px;
        background: linear-gradient(90deg, transparent, rgba(43, 108, 176, 0.3), transparent);
      }

      /* Ê†áÈ¢ò‰πüÂ±Ö‰∏≠ */
      h1 {
        width: 100%;
        text-align: center;
        margin: 0 auto;
      }

      /* ËØ¥ÊòéÊñáÊú¨‰πüÂ±Ö‰∏≠ */
      .exercise-instruction {
        width: 100%;
        text-align: center;
        margin: 1em auto;
      }

      /* ‰ΩøÁî®Êõ¥Áé∞‰ª£ÁöÑÈÄâÊã©Âô® */
      .horizontal-layout {
        display: flex;
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
        gap: 40px;
        margin-top: 10px;
        padding: 40px;
        background-color: var(--background-color);
        border-radius: var(--border-radius);
        position: relative;
        isolation: isolate;
      }

      /* ‰ΩøÁî®Êõ¥Áé∞‰ª£ÁöÑ‰º™ÂÖÉÁ¥†ËØ≠Ê≥ï */
      .horizontal-layout::before {
        content: '';
        position: absolute;
        inset: 0;
        background: 
          repeating-linear-gradient(
            45deg,
            rgba(255, 252, 242, 0.8),
            rgba(255, 252, 242, 0.8) 2px,
            rgba(255, 255, 255, 0.8) 3px,
            rgba(255, 255, 255, 0.8) 4px
          );
        border-radius: inherit;
        z-index: -1;
      }

      .horizontal-layout::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(
          to right,
          transparent,
          var(--shadow-color) 20%,
          var(--shadow-color) 80%,
          transparent
        );
        transform: translateX(-50%);
        z-index: -1;
      }

      /* ‰ΩøÁî®Êõ¥Áé∞‰ª£ÁöÑËøáÊ∏°ÊïàÊûú */
      .H5P-container, .gec-asr-container {
        background: var(--background-color);
        border-radius: var(--border-radius);
        box-shadow: 
          0 4px 8px var(--shadow-color);
        transition: transform 0.3s ease,
                    box-shadow 0.3s ease;
        will-change: transform;
      }

      @media (prefers-reduced-motion: reduce) {
        .H5P-container,
        .gec-asr-container,
        .nav-button {
          transition: none;
        }
      }

      /* ‰ΩøÁî®Êõ¥Áé∞‰ª£ÁöÑÂ™í‰ΩìÊü•ËØ¢ËØ≠Ê≥ï */
      @media screen and (max-width: 1200px) {
        .horizontal-layout {
          padding: 20px;
        }
        
        .horizontal-layout::after {
          width: 100%;
          height: 4px;
          top: 50%;
          left: 0;
          transform: translateY(-50%);
        }
      }
    </style>
  </head>

  <body>
    <div class="header">
      <div class="header-content">
        <div class="text-container">
          <h1>Computer Assisted language Learning</h1>
          <p>by [Jianan Wang]</p>
        </div>
      </div>
    </div>

    <div class="page-container">
      <div class="container">
        <div class="center">
          <h1>The Book of Dutch Answers</h1>
        </div>
        <p class="exercise-instruction">
          Practice Dutch A1 level speaking with interactive dialog cards and grammar feedback tools.
        </p>
      </div>

      <!-- Ê∞¥Âπ≥Â∏ÉÂ±ÄÂÆπÂô® -->
      <div class="horizontal-layout">
        <!-- Â∑¶‰æßÂØπËØùÂç°Áâá -->
        <div class="H5P-container">
          <iframe class="H5P-iframe" 
                  src="Dutch-A1-Speaking-Practice-Dialog-Cards-Code.html"
                  frameborder="0"
                  scrolling="no"
                  allowfullscreen
                  allow="autoplay *; geolocation *; microphone *; camera *; midi *; encrypted-media *">
          </iframe>
        </div>

        <!-- Âè≥‰æßGEC-ASRÂäüËÉΩÈÉ®ÂàÜ -->
        <div class="gec-asr-container">
          <h2>üéì Dutch Grammar and Pronunciation Practice</h2>
          <p>Record your Dutch sentences and get instant grammar feedback with pronunciation assistance.</p>

          <button id="startBtn">üéôÔ∏è Start Recording</button>
          <button id="stopBtn" disabled>‚èπÔ∏è Stop & Analyze</button>
          <button id="playTTS" disabled>üîä Play Corrected Sentence</button>

          <h2>üìù Recognized Sentence:</h2>
          <pre id="asrText">Waiting for audio input...</pre>

          <h2>‚úÖ Grammar Feedback:</h2>
          <div class="output" id="gecResult">Your grammar feedback will appear here after recording.</div>
        </div>
      </div>

      <!-- ÂØºËà™ÊåâÈíÆ -->
      <div class="exercise-navigation">
        <a href="../../index.html" class="nav-button">‚Üê Back to Home</a>
      </div>
    </div>

    <script>
      // ‰ΩøÁî®Êõ¥Áé∞‰ª£ÁöÑJavaScriptËØ≠Ê≥ï
      const initializeIframe = () => {
        const iframe = document.querySelector('.H5P-iframe');
        
        if (!iframe) {
          console.error('Iframe element not found');
          return;
        }

        // ‰ΩøÁî®CSSÂèòÈáè
        iframe.style.setProperty('opacity', '0');
        
        const handleIframeLoad = () => {
          requestAnimationFrame(() => {
            iframe.style.setProperty('opacity', '1');
            
            try {
              const iframeDoc = iframe.contentDocument ?? iframe.contentWindow?.document;
              if (!iframeDoc) {
                throw new Error('Êó†Ê≥ïËÆøÈóÆiframeÊñáÊ°£');
              }

              const content = iframeDoc.body ?? iframeDoc.documentElement;
              if (content) {
                const newHeight = Math.max(800, content.scrollHeight + 50);
                iframe.style.setProperty('height', `${newHeight}px`);
              }
            } catch(error) {
              console.error("Êó†Ê≥ïË∞ÉÊï¥iframeÈ´òÂ∫¶:", error);
              iframe.style.setProperty('height', '800px');
            }
          });
        };

        iframe.addEventListener('load', handleIframeLoad);
        iframe.addEventListener('error', (error) => {
          console.error('IframeÂä†ËΩΩÂ§±Ë¥•:', error);
          iframe.style.setProperty('opacity', '1');
          iframe.style.setProperty('height', '800px');
        });
      };

      // ‰ΩøÁî®Êõ¥Áé∞‰ª£ÁöÑDOMÂä†ËΩΩÊ£ÄÊµã
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeIframe);
      } else {
        initializeIframe();
      }

      // ‰ΩøÁî®Èò≤Êäñ‰ºòÂåñÂÆöÊúüÊ£ÄÊü•
      const debounce = (fn, delay) => {
        let timeoutId;
        return (...args) => {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => fn(...args), delay);
        };
      };

      const checkIframeHeight = debounce(() => {
        const iframe = document.querySelector('.H5P-iframe');
        if (!iframe?.contentWindow) return;

        try {
          const doc = iframe.contentDocument ?? iframe.contentWindow.document;
          if (doc?.body) {
            const newHeight = Math.max(800, doc.body.scrollHeight + 50);
            iframe.style.setProperty('height', `${newHeight}px`);
          }
        } catch(error) {
          console.warn('Ê£ÄÊü•iframeÈ´òÂ∫¶Â§±Ë¥•:', error);
        }
      }, 250);

      // ‰ΩøÁî®IntersectionObserver‰ºòÂåñÊÄßËÉΩ
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            checkIframeHeight();
          }
        });
      });

      document.querySelector('.H5P-iframe') && 
      observer.observe(document.querySelector('.H5P-iframe'));

      // Script for GEC-ASR functionality
      let mediaRecorder;
      let audioChunks = [];
      let correctedSentence = "";

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const playTTS = document.getElementById("playTTS");
      const asrText = document.getElementById("asrText");
      const gecResult = document.getElementById("gecResult");

      function highlightDiff(original, corrected) {
        const oWords = original.split(/(\s+)/);
        const cWords = corrected.split(/(\s+)/);
        let resultO = [], resultC = [];

        for (let i = 0; i < Math.max(oWords.length, cWords.length); i++) {
          if (oWords[i] !== cWords[i]) {
            if (oWords[i]) resultO.push(`<mark>${oWords[i]}</mark>`);
            if (cWords[i]) resultC.push(`<mark>${cWords[i]}</mark>`);
          } else {
            if (oWords[i]) resultO.push(oWords[i]);
            if (cWords[i]) resultC.push(cWords[i]);
          }
        }

        return [resultO.join(""), resultC.join("")];
      }

      startBtn.onclick = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => e.data.size > 0 && audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const formData = new FormData();
          formData.append('file', audioBlob, 'audio.webm');
          formData.append('model_id', 'scribe_v1');

          asrText.textContent = "‚è≥ Recognizing...";
          gecResult.textContent = "‚è≥ Analyzing grammar...";

          try {
            const asrResp = await fetch("https://api.elevenlabs.io/v1/speech-to-text", {
              method: "POST",
              headers: { "xi-api-key": "sk_d9f2022e022759193013a5169cb0a22b294c663dff788ccc" },
              body: formData
            });

            const asrData = await asrResp.json();
            const sentence = asrData.text || "No speech detected.";
            asrText.textContent = sentence;

            const prompt = `You are a Dutch language teacher. Please help correct the grammar of the following Dutch sentence. Provide feedback in the following format:\nOriginal:\nCorrected:\nError Type:\nExplanation (in English):\n\nSentence: ${sentence}`;

            const gecResp = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer sk-668561ddc7004f5f85c969bcb6e8e6fe"
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [{ role: "user", content: prompt }],
                stream: false
              })
            });

            const gecData = await gecResp.json();
            const feedback = gecData.choices?.[0]?.message?.content || "‚ö†Ô∏è No feedback returned.";

            const orig = feedback.match(/Original:\s*(.+)/i)?.[1] || "";
            correctedSentence = feedback.match(/Corrected:\s*(.+)/i)?.[1] || "";
            const errorType = feedback.match(/Error Type:\s*(.+)/i)?.[1] || "";
            const explanation = feedback.match(/Explanation.*?:\s*([\s\S]+)/i)?.[1] || "";

            const [hlOrig, hlCorr] = highlightDiff(orig, correctedSentence);
            gecResult.innerHTML = `
              <strong>Original:</strong> ${hlOrig}<br>
              <strong>Corrected:</strong> ${hlCorr}<br>
              <strong>Error Type:</strong> ${errorType}<br>
              <strong>Explanation:</strong> ${explanation.trim()}
            `;

            playTTS.disabled = false;
          } catch (err) {
            asrText.textContent = "‚ùå Recognition failed: " + err.message;
            gecResult.textContent = "‚ùå Unable to analyze grammar.";
          }
        };

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        playTTS.disabled = true;
        asrText.textContent = "üé§ Listening...";
      };

      stopBtn.onclick = () => {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
      };

      playTTS.onclick = async () => {
        try {
          const ttsResp = await fetch("https://api.elevenlabs.io/v1/text-to-speech/pNInz6obpgDQGcFmaJgB", {
            method: "POST",
            headers: {
              "xi-api-key": "sk_59570cb6e5fc7c881c90f29ae74d13ae4958cbb341118acc",
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ text: correctedSentence, model_id: "eleven_monolingual_v1" })
          });
          const audioBlob = await ttsResp.blob();
          const audioURL = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioURL);
          audio.play();
        } catch (err) {
          alert("TTS failed: " + err.message);
        }
      };
    </script>
  </body>
</html>
