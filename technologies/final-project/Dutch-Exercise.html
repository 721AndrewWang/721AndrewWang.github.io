<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CALL Blog</title>
    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="../../styles.css" />
    <style>
      .H5P-container {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 0; /* Ë∞ÉÊï¥ËæπË∑ù */
        width: 100%;
        max-width: 700px; /* ÂáèÂ∞èÂÆΩÂ∫¶‰ª•ÈÄÇÂ∫îÂπ∂Êéí */
        padding: 0 20px;
        position: relative;
        flex: 1; /* ÂºπÊÄßÂ∏ÉÂ±Ä */
        min-width: 300px; /* ÊúÄÂ∞èÂÆΩÂ∫¶ÔºåÈÅøÂÖçÂ§™Á™Ñ */
      }
      
      .H5P-iframe {
        border: none;
        width: 100%;
        min-height: 800px;
        height: auto;
        display: block;
        z-index: 10;
        position: relative;
        background-color: white;
        overflow: hidden;
      }

      /* Ê∑ªÂä†ÈÅÆÁΩ©Â±ÇÔºåÈò≤Ê≠¢ÊñáÂ≠óÊòæÁ§∫ */
      .iframe-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100px;
        background-color: white;
        z-index: 5;
      }

      .page-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 100%;
        max-width: 1600px;
        margin: 0 auto;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        text-align: center;
        margin-bottom: 20px;
      }

      .center {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        text-align: center;
        padding: 40px 20px;
        margin-bottom: 0;
      }

      .center h1 {
        font-size: 2.5em;
        margin: 0;
        padding: 0;
        color: #2b2b2b;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .exercise-instruction {
        width: 100%;
        text-align: center;
        margin: 1.5em auto;
        color: #666;
        font-size: 1.1em;
        line-height: 1.6;
        max-width: 800px;
      }

      .exercise-navigation {
        display: flex;
        justify-content: center;
        margin: 2em 0;
        padding: 0 20px;
      }
      
      /* Ê∑ªÂä†ÂØºËà™ÊåâÈíÆÊ†∑Âºè */
      .nav-button {
        display: inline-block;
        padding: 8px 16px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        color: #2b6cb0;
        text-decoration: none;
        font-size: 1em;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .nav-button:hover {
        background-color: #2b6cb0;
        color: white;
        transform: translateY(-2px);
      }

      /* GEC-ASR ÂäüËÉΩÊ†∑Âºè */
      .gec-asr-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 700px; /* ÂáèÂ∞èÂÆΩÂ∫¶‰ª•ÈÄÇÂ∫îÂπ∂Êéí */
        text-align: center;
        background: rgba(255, 255, 255, 0.98);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin: 0; /* Ë∞ÉÊï¥ËæπË∑ù */
        flex: 1; /* ÂºπÊÄßÂ∏ÉÂ±Ä */
        min-width: 300px; /* ÊúÄÂ∞èÂÆΩÂ∫¶ÔºåÈÅøÂÖçÂ§™Á™Ñ */
      }

      .gec-asr-container h2 {
        color: #2b6cb0;
        margin-bottom: 20px;
        width: 100%;
        text-align: center;
      }

      .gec-asr-container p {
        color: #4a5568;
        line-height: 1.6;
        margin-bottom: 20px;
      }

      button {
        padding: 12px 24px;
        font-size: 16px;
        margin: 10px 5px;
        cursor: pointer;
        background-color: #2b6cb0;
        color: white;
        border: none;
        border-radius: 25px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      pre, .output {
        background: rgba(255, 255, 255, 0.98);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        text-align: left;
        white-space: pre-wrap;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        width: 100%;
        max-width: 700px;
      }

      mark {
        background-color: #ffeb3b;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
      }

      .output strong {
        color: #2b6cb0;
        display: block;
        margin-top: 15px;
      }

      .section-divider {
        width: 100%;
        max-width: 800px;
        margin: 30px auto;
        height: 2px;
        background: linear-gradient(90deg, transparent, rgba(43, 108, 176, 0.3), transparent);
      }

      /* Ê†áÈ¢ò‰πüÂ±Ö‰∏≠ */
      h1 {
        width: 100%;
        text-align: center;
        margin: 0 auto;
      }

      /* ËØ¥ÊòéÊñáÊú¨‰πüÂ±Ö‰∏≠ */
      .exercise-instruction {
        width: 100%;
        text-align: center;
        margin: 1em auto;
      }

      /* Ê∑ªÂä†Ê∞¥Âπ≥Â∏ÉÂ±ÄÂÆπÂô® */
      .horizontal-layout {
        display: flex;
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
        gap: 40px;
        margin-top: 10px;
        padding: 40px;
        background: 
          /* Á∫∏Âº†Á∫πÁêÜ */
          repeating-linear-gradient(
            45deg,
            rgba(255, 252, 242, 0.8),
            rgba(255, 252, 242, 0.8) 2px,
            rgba(255, 255, 255, 0.8) 3px,
            rgba(255, 255, 255, 0.8) 4px
          ),
          /* ‰π¶È°µÈ¢úËâ≤Ê∏êÂèò */
          linear-gradient(
            to right,
            #f4efe4 0%,
            #fff7e6 3%,
            #fffdf7 7%,
            #fffdf7 93%,
            #fff7e6 97%,
            #f4efe4 100%
          );
        border-radius: 12px;
        position: relative;
        box-shadow: 
          /* Â§ñÈÉ®Èò¥ÂΩ± */
          0 20px 40px rgba(0, 0, 0, 0.1),
          /* ÂÜÖÈÉ®Èò¥ÂΩ±ÔºåÂ¢ûÂä†Ê∑±Â∫¶ÊÑü */
          inset 0 0 30px rgba(0, 0, 0, 0.05),
          /* ‰π¶È°µËæπÁºòÈò¥ÂΩ± */
          inset -2px 0 5px rgba(0, 0, 0, 0.05),
          inset 2px 0 5px rgba(0, 0, 0, 0.05);
      }

      /* ‰π¶È°µÁ∫πÁêÜÊïàÊûú */
      .horizontal-layout::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: 
          /* Ê®™Á∫øÁ∫πÁêÜ */
          repeating-linear-gradient(
            to bottom,
            transparent 0px,
            transparent 23px,
            rgba(0, 0, 0, 0.02) 24px,
            rgba(0, 0, 0, 0.02) 25px
          ),
          /* Á∫∏Âº†Âô™ÁÇπÁ∫πÁêÜ */
          url('data:image/png;base64,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');
        opacity: 0.03;
        pointer-events: none;
        border-radius: 12px;
        mix-blend-mode: multiply;
      }

      /* ‰π¶ËÑäÊïàÊûúÂ¢ûÂº∫ */
      .horizontal-layout::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 0;
        width: 4px; /* Â¢ûÂä†‰π¶ËÑäÂÆΩÂ∫¶ */
        height: 100%;
        background: 
          /* ‰π¶ËÑäÁ∫πÁêÜ */
          linear-gradient(
            to right,
            transparent,
            rgba(0, 0, 0, 0.1) 20%,
            rgba(0, 0, 0, 0.1) 80%,
            transparent
          ),
          /* ‰π¶ËÑäÈò¥ÂΩ± */
          linear-gradient(
            to right,
            #e4d5c3,
            #f4e4d0 30%,
            #f4e4d0 70%,
            #e4d5c3
          );
        transform: translateX(-50%);
        box-shadow: 
          /* ‰π¶ËÑäÈò¥ÂΩ±ÊïàÊûú */
          -2px 0 4px rgba(0, 0, 0, 0.1),
          2px 0 4px rgba(0, 0, 0, 0.1),
          inset -1px 0 2px rgba(255, 255, 255, 0.5),
          inset 1px 0 2px rgba(255, 255, 255, 0.5);
      }

      /* ÂÜÖÂÆπÂå∫ÂùóÊ†∑Âºè‰ºòÂåñ */
      .H5P-container, .gec-asr-container {
        background: rgba(255, 255, 255, 0.97);
        border-radius: 12px;
        box-shadow: 
          /* Â§ñÈÉ®Èò¥ÂΩ± */
          0 4px 8px rgba(0, 0, 0, 0.05),
          0 1px 3px rgba(0, 0, 0, 0.1),
          /* ÂÜÖÈÉ®Èò¥ÂΩ±ÔºåÂ¢ûÂä†Á∫∏Âº†ÊÑü */
          inset 0 0 0 1px rgba(255, 255, 255, 0.9),
          inset 0 0 20px rgba(0, 0, 0, 0.02);
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
      }

      .H5P-container:hover, .gec-asr-container:hover {
        transform: translateY(-2px);
        box-shadow: 
          0 6px 12px rgba(0, 0, 0, 0.08),
          0 2px 4px rgba(0, 0, 0, 0.12),
          inset 0 0 0 1px rgba(255, 255, 255, 0.9),
          inset 0 0 20px rgba(0, 0, 0, 0.02);
      }

      /* ÂìçÂ∫îÂºèË∞ÉÊï¥‰ºòÂåñ */
      @media (max-width: 1200px) {
        .horizontal-layout {
          padding: 20px;
        }
        
        .horizontal-layout::after {
          width: 100%;
          height: 4px;
          top: 50%;
          left: 0;
          transform: translateY(-50%);
          background: 
            linear-gradient(
              to bottom,
              transparent,
              rgba(0, 0, 0, 0.1) 20%,
              rgba(0, 0, 0, 0.1) 80%,
              transparent
            ),
            linear-gradient(
              to bottom,
              #e4d5c3,
              #f4e4d0 30%,
              #f4e4d0 70%,
              #e4d5c3
            );
          box-shadow: 
            0 -2px 4px rgba(0, 0, 0, 0.1),
            0 2px 4px rgba(0, 0, 0, 0.1),
            inset 0 -1px 2px rgba(255, 255, 255, 0.5),
            inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }
      }
    </style>
  </head>

  <body>
    <div class="header">
      <div class="header-content">
        <div class="text-container">
          <h1>Computer Assisted language Learning</h1>
          <p>by [Jianan Wang]</p>
        </div>
      </div>
    </div>

    <div class="page-container">
      <div class="container">
        <div class="center">
          <h1>The Book of Dutch Answers</h1>
        </div>
        <p class="exercise-instruction">
          Practice Dutch A1 level speaking with interactive dialog cards and grammar feedback tools.
        </p>
      </div>

      <!-- Ê∞¥Âπ≥Â∏ÉÂ±ÄÂÆπÂô® -->
      <div class="horizontal-layout">
        <!-- Â∑¶‰æßÂØπËØùÂç°Áâá -->
        <div class="H5P-container">
          <!-- Ê∑ªÂä†‰∏Ä‰∏™ÈÅÆÁΩ©Â±Ç -->
          <div class="iframe-overlay"></div>
          <iframe class="H5P-iframe" src="./Dutch-A1-Speaking-Practice-Dialog-Cards-Code.html"></iframe>
        </div>

        <!-- Âè≥‰æßGEC-ASRÂäüËÉΩÈÉ®ÂàÜ -->
        <div class="gec-asr-container">
          <h2>üéì Dutch Grammar and Pronunciation Practice</h2>
          <p>Record your Dutch sentences and get instant grammar feedback with pronunciation assistance.</p>

          <button id="startBtn">üéôÔ∏è Start Recording</button>
          <button id="stopBtn" disabled>‚èπÔ∏è Stop & Analyze</button>
          <button id="playTTS" disabled>üîä Play Corrected Sentence</button>

          <h2>üìù Recognized Sentence:</h2>
          <pre id="asrText">Waiting for audio input...</pre>

          <h2>‚úÖ Grammar Feedback:</h2>
          <div class="output" id="gecResult">Your grammar feedback will appear here after recording.</div>
        </div>
      </div>

      <!-- ÂØºËà™ÊåâÈíÆ -->
      <div class="exercise-navigation">
        <a href="../../index.html" class="nav-button">‚Üê Back to Home</a>
      </div>
    </div>

    <script>
      // ÂÖ®Â±ÄÁä∂ÊÄÅÁÆ°ÁêÜ
      const state = {
        isRecording: false,
        isProcessing: false,
        retryCount: 0,
        maxRetries: 3,
        apiKeys: {
          elevenlabs: "sk_d9f2022e022759193013a5169cb0a22b294c663dff788ccc",
          deepseek: "sk-668561ddc7004f5f85c969bcb6e8e6fe"
        }
      };

      // ÈîôËØØÂ§ÑÁêÜÂíåÈáçËØïÊú∫Âà∂
      async function retryOperation(operation, maxRetries = 3) {
        for (let i = 0; i < maxRetries; i++) {
          try {
            return await operation();
          } catch (error) {
            if (i === maxRetries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
          }
        }
      }

      // iframeÂä†ËΩΩÂíåÈ´òÂ∫¶Ë∞ÉÊï¥ÁöÑÁ®≥ÂÆöÊÄßÂ¢ûÂº∫
      function initializeIframe() {
        const iframe = document.querySelector('.H5P-iframe');
        const overlay = document.querySelector('.iframe-overlay');
        
        if (!iframe || !overlay) {
          console.error('Required elements not found');
          return;
        }

        let loadAttempts = 0;
        const maxLoadAttempts = 3;

        function adjustIframeHeight() {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (!iframeDoc) {
              throw new Error('Êó†Ê≥ïËÆøÈóÆiframeÊñáÊ°£');
            }

            const content = iframeDoc.body || iframeDoc.documentElement;
            if (content) {
              const newHeight = content.scrollHeight + 50;
              iframe.style.height = `${newHeight}px`;
              
              // Êõ¥Êñ∞ÊñáÊú¨ÂÜÖÂÆπ
              try {
                const paragraphs = iframeDoc.querySelectorAll('p, div');
                for (const el of paragraphs) {
                  if (el.textContent.includes('Read the question on the front of each card.')) {
                    el.innerHTML = el.textContent.replace(
                      'Read the question on the front of each card. Click to flip and check the model answer. Try to repeat the answer aloud.',
                      'Read the question on the front of each card.<br>Click to flip and check the model answer.<br>Try to repeat the answer aloud.'
                    );
                    break;
                  }
                }
              } catch (e) {
                console.warn('ÊñáÊú¨Êõ¥Êñ∞Â§±Ë¥•:', e);
              }
            }
          } catch (e) {
            console.warn('iframeÈ´òÂ∫¶Ë∞ÉÊï¥Â§±Ë¥•:', e);
            if (loadAttempts < maxLoadAttempts) {
              loadAttempts++;
              setTimeout(adjustIframeHeight, 1000);
            }
          }
        }

        iframe.onload = function() {
          setTimeout(() => {
            overlay.style.display = 'none';
            adjustIframeHeight();
          }, 1000);
        };

        // Ê∑ªÂä†ÈîôËØØÂ§ÑÁêÜ
        iframe.onerror = function() {
          console.error('iframeÂä†ËΩΩÂ§±Ë¥•');
          overlay.style.display = 'none';
        };
      }

      // Èü≥È¢ëÂ§ÑÁêÜÂ¢ûÂº∫
      class AudioHandler {
        constructor() {
          this.mediaRecorder = null;
          this.audioChunks = [];
          this.stream = null;
        }

        async startRecording() {
          try {
            this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.mediaRecorder = new MediaRecorder(this.stream);
            this.audioChunks = [];

            this.mediaRecorder.ondataavailable = e => {
              if (e.data.size > 0) {
                this.audioChunks.push(e.data);
              }
            };

            this.mediaRecorder.start();
            state.isRecording = true;
            return true;
          } catch (error) {
            console.error('ÂΩïÈü≥ÂêØÂä®Â§±Ë¥•:', error);
            return false;
          }
        }

        stopRecording() {
          if (this.mediaRecorder && state.isRecording) {
            this.mediaRecorder.stop();
            this.stream.getTracks().forEach(track => track.stop());
            state.isRecording = false;
            return new Blob(this.audioChunks, { type: 'audio/webm' });
          }
          return null;
        }
      }

      // APIË∞ÉÁî®Â¢ûÂº∫
      class APIService {
        static async performASR(audioBlob) {
          const formData = new FormData();
          formData.append('file', audioBlob, 'audio.webm');
          formData.append('model_id', 'scribe_v1');

          return await retryOperation(async () => {
            const response = await fetch("https://api.elevenlabs.io/v1/speech-to-text", {
              method: "POST",
              headers: { "xi-api-key": state.apiKeys.elevenlabs },
              body: formData
            });

            if (!response.ok) {
              throw new Error(`ASR APIÈîôËØØ: ${response.status}`);
            }

            return await response.json();
          });
        }

        static async performGEC(sentence) {
          const prompt = `You are a Dutch language teacher. Please help correct the grammar of the following Dutch sentence. Provide feedback in the following format:\nOriginal:\nCorrected:\nError Type:\nExplanation (in English):\n\nSentence: ${sentence}`;

          return await retryOperation(async () => {
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${state.apiKeys.deepseek}`
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [{ role: "user", content: prompt }],
                stream: false
              })
            });

            if (!response.ok) {
              throw new Error(`GEC APIÈîôËØØ: ${response.status}`);
            }

            return await response.json();
          });
        }

        static async performTTS(text) {
          return await retryOperation(async () => {
            const response = await fetch("https://api.elevenlabs.io/v1/text-to-speech/pNInz6obpgDQGcFmaJgB", {
              method: "POST",
              headers: {
                "xi-api-key": state.apiKeys.elevenlabs,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ 
                text: text, 
                model_id: "eleven_monolingual_v1" 
              })
            });

            if (!response.ok) {
              throw new Error(`TTS APIÈîôËØØ: ${response.status}`);
            }

            return await response.blob();
          });
        }
      }

      // UIÊõ¥Êñ∞ÂáΩÊï∞
      function updateUI(status, message) {
        const asrText = document.getElementById("asrText");
        const gecResult = document.getElementById("gecResult");
        
        switch(status) {
          case 'listening':
            asrText.textContent = "üé§ Listening...";
            break;
          case 'processing':
            asrText.textContent = "‚è≥ Recognizing...";
            gecResult.textContent = "‚è≥ Analyzing grammar...";
            break;
          case 'error':
            asrText.textContent = `‚ùå ${message}`;
            gecResult.textContent = "‚ùå Unable to analyze grammar.";
            break;
          case 'success':
            asrText.textContent = message;
            break;
        }
      }

      // ÂàùÂßãÂåñ
      document.addEventListener('DOMContentLoaded', () => {
        initializeIframe();
        
        const audioHandler = new AudioHandler();
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const playTTS = document.getElementById("playTTS");
        const gecResult = document.getElementById("gecResult");
        let correctedSentence = "";

        startBtn.onclick = async () => {
          if (state.isProcessing) return;
          
          const success = await audioHandler.startRecording();
          if (success) {
            startBtn.disabled = true;
            stopBtn.disabled = false;
            playTTS.disabled = true;
            updateUI('listening');
          } else {
            updateUI('error', 'Êó†Ê≥ïÂêØÂä®ÂΩïÈü≥ËÆæÂ§á');
          }
        };

        stopBtn.onclick = async () => {
          if (!state.isRecording) return;
          
          state.isProcessing = true;
          const audioBlob = audioHandler.stopRecording();
          startBtn.disabled = false;
          stopBtn.disabled = true;
          
          if (!audioBlob) {
            updateUI('error', 'ÂΩïÈü≥Â§±Ë¥•');
            state.isProcessing = false;
            return;
          }

          try {
            updateUI('processing');
            
            const asrData = await APIService.performASR(audioBlob);
            const sentence = asrData.text || "No speech detected.";
            updateUI('success', sentence);

            const gecData = await APIService.performGEC(sentence);
            const feedback = gecData.choices?.[0]?.message?.content || "‚ö†Ô∏è No feedback returned.";

            const orig = feedback.match(/Original:\s*(.+)/i)?.[1] || "";
            correctedSentence = feedback.match(/Corrected:\s*(.+)/i)?.[1] || "";
            const errorType = feedback.match(/Error Type:\s*(.+)/i)?.[1] || "";
            const explanation = feedback.match(/Explanation.*?:\s*([\s\S]+)/i)?.[1] || "";

            const [hlOrig, hlCorr] = highlightDiff(orig, correctedSentence);
            gecResult.innerHTML = `
              <strong>Original:</strong> ${hlOrig}<br>
              <strong>Corrected:</strong> ${hlCorr}<br>
              <strong>Error Type:</strong> ${errorType}<br>
              <strong>Explanation:</strong> ${explanation.trim()}
            `;

            playTTS.disabled = false;
          } catch (error) {
            console.error('Â§ÑÁêÜÂ§±Ë¥•:', error);
            updateUI('error', error.message);
          } finally {
            state.isProcessing = false;
          }
        };

        playTTS.onclick = async () => {
          if (!correctedSentence || state.isProcessing) return;
          
          try {
            state.isProcessing = true;
            const audioBlob = await APIService.performTTS(correctedSentence);
            const audioURL = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioURL);
            await audio.play();
          } catch (error) {
            console.error('TTSÂ§±Ë¥•:', error);
            alert("TTS failed: " + error.message);
          } finally {
            state.isProcessing = false;
          }
        };
      });
    </script>
  </body>
</html>
