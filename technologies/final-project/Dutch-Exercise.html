<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CALL Blog</title>
    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="../../styles.css" />
    <style>
      .H5P-container {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 0; /* 调整边距 */
        width: 100%;
        max-width: 700px; /* 减小宽度以适应并排 */
        padding: 0 20px;
        position: relative;
        flex: 1; /* 弹性布局 */
        min-width: 300px; /* 最小宽度，避免太窄 */
      }
      
      .H5P-iframe {
        border: none;
        width: 100%;
        min-height: 800px;
        height: auto;
        display: block;
        z-index: 10;
        position: relative;
        background-color: white;
        overflow: hidden;
      }

      /* 添加遮罩层，防止文字显示 */
      .iframe-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100px;
        background-color: white;
        z-index: 5;
      }

      .page-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 100%;
        max-width: 1600px;
        margin: 0 auto;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        text-align: center;
        margin-bottom: 20px;
      }

      .center {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        text-align: center;
        padding: 40px 20px;
        margin-bottom: 0;
      }

      .center h1 {
        font-size: 2.5em;
        margin: 0;
        padding: 0;
        color: #2b2b2b;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .exercise-instruction {
        width: 100%;
        text-align: center;
        margin: 1.5em auto;
        color: #666;
        font-size: 1.1em;
        line-height: 1.6;
        max-width: 800px;
      }

      .exercise-navigation {
        display: flex;
        justify-content: center;
        margin: 2em 0;
        padding: 0 20px;
      }
      
      /* 添加导航按钮样式 */
      .nav-button {
        display: inline-block;
        padding: 8px 16px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        color: #2b6cb0;
        text-decoration: none;
        font-size: 1em;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .nav-button:hover {
        background-color: #2b6cb0;
        color: white;
        transform: translateY(-2px);
      }

      /* GEC-ASR 功能样式 */
      .gec-asr-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 700px; /* 减小宽度以适应并排 */
        text-align: center;
        background: rgba(255, 255, 255, 0.98);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin: 0; /* 调整边距 */
        flex: 1; /* 弹性布局 */
        min-width: 300px; /* 最小宽度，避免太窄 */
      }

      .gec-asr-container h2 {
        color: #2b6cb0;
        margin-bottom: 20px;
        width: 100%;
        text-align: center;
      }

      .gec-asr-container p {
        color: #4a5568;
        line-height: 1.6;
        margin-bottom: 20px;
      }

      button {
        padding: 12px 24px;
        font-size: 16px;
        margin: 10px 5px;
        cursor: pointer;
        background-color: #2b6cb0;
        color: white;
        border: none;
        border-radius: 25px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      pre, .output {
        background: rgba(255, 255, 255, 0.98);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        text-align: left;
        white-space: pre-wrap;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        width: 100%;
        max-width: 700px;
      }

      mark {
        background-color: #ffeb3b;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
      }

      .output strong {
        color: #2b6cb0;
        display: block;
        margin-top: 15px;
      }

      .section-divider {
        width: 100%;
        max-width: 800px;
        margin: 30px auto;
        height: 2px;
        background: linear-gradient(90deg, transparent, rgba(43, 108, 176, 0.3), transparent);
      }

      /* 标题也居中 */
      h1 {
        width: 100%;
        text-align: center;
        margin: 0 auto;
      }

      /* 说明文本也居中 */
      .exercise-instruction {
        width: 100%;
        text-align: center;
        margin: 1em auto;
      }

      /* 添加水平布局容器 */
      .horizontal-layout {
        display: flex;
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
        gap: 40px;
        margin-top: 10px;
        padding: 40px;
        background: 
          /* 纸张纹理 */
          repeating-linear-gradient(
            45deg,
            rgba(255, 252, 242, 0.8),
            rgba(255, 252, 242, 0.8) 2px,
            rgba(255, 255, 255, 0.8) 3px,
            rgba(255, 255, 255, 0.8) 4px
          ),
          /* 书页颜色渐变 */
          linear-gradient(
            to right,
            #f4efe4 0%,
            #fff7e6 3%,
            #fffdf7 7%,
            #fffdf7 93%,
            #fff7e6 97%,
            #f4efe4 100%
          );
        border-radius: 12px;
        position: relative;
        box-shadow: 
          /* 外部阴影 */
          0 20px 40px rgba(0, 0, 0, 0.1),
          /* 内部阴影，增加深度感 */
          inset 0 0 30px rgba(0, 0, 0, 0.05),
          /* 书页边缘阴影 */
          inset -2px 0 5px rgba(0, 0, 0, 0.05),
          inset 2px 0 5px rgba(0, 0, 0, 0.05);
      }

      /* 书页纹理效果 */
      .horizontal-layout::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: 
          /* 横线纹理 */
          repeating-linear-gradient(
            to bottom,
            transparent 0px,
            transparent 23px,
            rgba(0, 0, 0, 0.02) 24px,
            rgba(0, 0, 0, 0.02) 25px
          ),
          /* 纸张噪点纹理 */
          url('data:image/png;base64,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');
        opacity: 0.03;
        pointer-events: none;
        border-radius: 12px;
        mix-blend-mode: multiply;
      }

      /* 书脊效果增强 */
      .horizontal-layout::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 0;
        width: 4px; /* 增加书脊宽度 */
        height: 100%;
        background: 
          /* 书脊纹理 */
          linear-gradient(
            to right,
            transparent,
            rgba(0, 0, 0, 0.1) 20%,
            rgba(0, 0, 0, 0.1) 80%,
            transparent
          ),
          /* 书脊阴影 */
          linear-gradient(
            to right,
            #e4d5c3,
            #f4e4d0 30%,
            #f4e4d0 70%,
            #e4d5c3
          );
        transform: translateX(-50%);
        box-shadow: 
          /* 书脊阴影效果 */
          -2px 0 4px rgba(0, 0, 0, 0.1),
          2px 0 4px rgba(0, 0, 0, 0.1),
          inset -1px 0 2px rgba(255, 255, 255, 0.5),
          inset 1px 0 2px rgba(255, 255, 255, 0.5);
      }

      /* 内容区块样式优化 */
      .H5P-container, .gec-asr-container {
        background: rgba(255, 255, 255, 0.97);
        border-radius: 12px;
        box-shadow: 
          /* 外部阴影 */
          0 4px 8px rgba(0, 0, 0, 0.05),
          0 1px 3px rgba(0, 0, 0, 0.1),
          /* 内部阴影，增加纸张感 */
          inset 0 0 0 1px rgba(255, 255, 255, 0.9),
          inset 0 0 20px rgba(0, 0, 0, 0.02);
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
      }

      .H5P-container:hover, .gec-asr-container:hover {
        transform: translateY(-2px);
        box-shadow: 
          0 6px 12px rgba(0, 0, 0, 0.08),
          0 2px 4px rgba(0, 0, 0, 0.12),
          inset 0 0 0 1px rgba(255, 255, 255, 0.9),
          inset 0 0 20px rgba(0, 0, 0, 0.02);
      }

      /* 响应式调整优化 */
      @media (max-width: 1200px) {
        .horizontal-layout {
          padding: 20px;
        }
        
        .horizontal-layout::after {
          width: 100%;
          height: 4px;
          top: 50%;
          left: 0;
          transform: translateY(-50%);
          background: 
            linear-gradient(
              to bottom,
              transparent,
              rgba(0, 0, 0, 0.1) 20%,
              rgba(0, 0, 0, 0.1) 80%,
              transparent
            ),
            linear-gradient(
              to bottom,
              #e4d5c3,
              #f4e4d0 30%,
              #f4e4d0 70%,
              #e4d5c3
            );
          box-shadow: 
            0 -2px 4px rgba(0, 0, 0, 0.1),
            0 2px 4px rgba(0, 0, 0, 0.1),
            inset 0 -1px 2px rgba(255, 255, 255, 0.5),
            inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }
      }
    </style>
  </head>

  <body>
    <div class="header">
      <div class="header-content">
        <div class="text-container">
          <h1>Computer Assisted language Learning</h1>
          <p>by [Jianan Wang]</p>
        </div>
      </div>
    </div>

    <div class="page-container">
      <div class="container">
        <div class="center">
          <h1>The Book of Dutch Answers</h1>
        </div>
        <p class="exercise-instruction">
          Practice Dutch A1 level speaking with interactive dialog cards and grammar feedback tools.
        </p>
      </div>

      <!-- 水平布局容器 -->
      <div class="horizontal-layout">
        <!-- 左侧对话卡片 -->
        <div class="H5P-container">
          <!-- 添加一个遮罩层 -->
          <div class="iframe-overlay"></div>
          <iframe class="H5P-iframe" src="./Dutch-A1-Speaking-Practice-Dialog-Cards-Code.html"></iframe>
        </div>

        <!-- 右侧GEC-ASR功能部分 -->
        <div class="gec-asr-container">
          <h2>🎓 Dutch Grammar and Pronunciation Practice</h2>
          <p>Record your Dutch sentences and get instant grammar feedback with pronunciation assistance.</p>

          <button id="startBtn">🎙️ Start Recording</button>
          <button id="stopBtn" disabled>⏹️ Stop & Analyze</button>
          <button id="playTTS" disabled>🔊 Play Corrected Sentence</button>

          <h2>📝 Recognized Sentence:</h2>
          <pre id="asrText">Waiting for audio input...</pre>

          <h2>✅ Grammar Feedback:</h2>
          <div class="output" id="gecResult">Your grammar feedback will appear here after recording.</div>
        </div>
      </div>

      <!-- 导航按钮 -->
      <div class="exercise-navigation">
        <a href="../../index.html" class="nav-button">← Back to Home</a>
      </div>
    </div>

    <script>
      // 全局状态管理
      const state = {
        isRecording: false,
        isProcessing: false,
        retryCount: 0,
        maxRetries: 3,
        apiKeys: {
          elevenlabs: "sk_d9f2022e022759193013a5169cb0a22b294c663dff788ccc",
          deepseek: "sk-668561ddc7004f5f85c969bcb6e8e6fe"
        }
      };

      // 错误处理和重试机制
      async function retryOperation(operation, maxRetries = 3) {
        for (let i = 0; i < maxRetries; i++) {
          try {
            return await operation();
          } catch (error) {
            if (i === maxRetries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
          }
        }
      }

      // iframe加载和高度调整的稳定性增强
      function initializeIframe() {
        const iframe = document.querySelector('.H5P-iframe');
        const overlay = document.querySelector('.iframe-overlay');
        
        if (!iframe || !overlay) {
          console.error('Required elements not found');
          return;
        }

        let loadAttempts = 0;
        const maxLoadAttempts = 3;

        function adjustIframeHeight() {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (!iframeDoc) {
              throw new Error('无法访问iframe文档');
            }

            const content = iframeDoc.body || iframeDoc.documentElement;
            if (content) {
              const newHeight = content.scrollHeight + 50;
              iframe.style.height = `${newHeight}px`;
              
              // 更新文本内容
              try {
                const paragraphs = iframeDoc.querySelectorAll('p, div');
                for (const el of paragraphs) {
                  if (el.textContent.includes('Read the question on the front of each card.')) {
                    el.innerHTML = el.textContent.replace(
                      'Read the question on the front of each card. Click to flip and check the model answer. Try to repeat the answer aloud.',
                      'Read the question on the front of each card.<br>Click to flip and check the model answer.<br>Try to repeat the answer aloud.'
                    );
                    break;
                  }
                }
              } catch (e) {
                console.warn('文本更新失败:', e);
              }
            }
          } catch (e) {
            console.warn('iframe高度调整失败:', e);
            if (loadAttempts < maxLoadAttempts) {
              loadAttempts++;
              setTimeout(adjustIframeHeight, 1000);
            }
          }
        }

        iframe.onload = function() {
          setTimeout(() => {
            overlay.style.display = 'none';
            adjustIframeHeight();
          }, 1000);
        };

        // 添加错误处理
        iframe.onerror = function() {
          console.error('iframe加载失败');
          overlay.style.display = 'none';
        };
      }

      // 音频处理增强
      class AudioHandler {
        constructor() {
          this.mediaRecorder = null;
          this.audioChunks = [];
          this.stream = null;
        }

        async startRecording() {
          try {
            this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.mediaRecorder = new MediaRecorder(this.stream);
            this.audioChunks = [];

            this.mediaRecorder.ondataavailable = e => {
              if (e.data.size > 0) {
                this.audioChunks.push(e.data);
              }
            };

            this.mediaRecorder.start();
            state.isRecording = true;
            return true;
          } catch (error) {
            console.error('录音启动失败:', error);
            return false;
          }
        }

        stopRecording() {
          if (this.mediaRecorder && state.isRecording) {
            this.mediaRecorder.stop();
            this.stream.getTracks().forEach(track => track.stop());
            state.isRecording = false;
            return new Blob(this.audioChunks, { type: 'audio/webm' });
          }
          return null;
        }
      }

      // API调用增强
      class APIService {
        static async performASR(audioBlob) {
          const formData = new FormData();
          formData.append('file', audioBlob, 'audio.webm');
          formData.append('model_id', 'scribe_v1');

          return await retryOperation(async () => {
            const response = await fetch("https://api.elevenlabs.io/v1/speech-to-text", {
              method: "POST",
              headers: { "xi-api-key": state.apiKeys.elevenlabs },
              body: formData
            });

            if (!response.ok) {
              throw new Error(`ASR API错误: ${response.status}`);
            }

            return await response.json();
          });
        }

        static async performGEC(sentence) {
          const prompt = `You are a Dutch language teacher. Please help correct the grammar of the following Dutch sentence. Provide feedback in the following format:\nOriginal:\nCorrected:\nError Type:\nExplanation (in English):\n\nSentence: ${sentence}`;

          return await retryOperation(async () => {
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${state.apiKeys.deepseek}`
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [{ role: "user", content: prompt }],
                stream: false
              })
            });

            if (!response.ok) {
              throw new Error(`GEC API错误: ${response.status}`);
            }

            return await response.json();
          });
        }

        static async performTTS(text) {
          return await retryOperation(async () => {
            const response = await fetch("https://api.elevenlabs.io/v1/text-to-speech/pNInz6obpgDQGcFmaJgB", {
              method: "POST",
              headers: {
                "xi-api-key": state.apiKeys.elevenlabs,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ 
                text: text, 
                model_id: "eleven_monolingual_v1" 
              })
            });

            if (!response.ok) {
              throw new Error(`TTS API错误: ${response.status}`);
            }

            return await response.blob();
          });
        }
      }

      // UI更新函数
      function updateUI(status, message) {
        const asrText = document.getElementById("asrText");
        const gecResult = document.getElementById("gecResult");
        
        switch(status) {
          case 'listening':
            asrText.textContent = "🎤 Listening...";
            break;
          case 'processing':
            asrText.textContent = "⏳ Recognizing...";
            gecResult.textContent = "⏳ Analyzing grammar...";
            break;
          case 'error':
            asrText.textContent = `❌ ${message}`;
            gecResult.textContent = "❌ Unable to analyze grammar.";
            break;
          case 'success':
            asrText.textContent = message;
            break;
        }
      }

      // 初始化
      document.addEventListener('DOMContentLoaded', () => {
        initializeIframe();
        
        const audioHandler = new AudioHandler();
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const playTTS = document.getElementById("playTTS");
        const gecResult = document.getElementById("gecResult");
        let correctedSentence = "";

        startBtn.onclick = async () => {
          if (state.isProcessing) return;
          
          const success = await audioHandler.startRecording();
          if (success) {
            startBtn.disabled = true;
            stopBtn.disabled = false;
            playTTS.disabled = true;
            updateUI('listening');
          } else {
            updateUI('error', '无法启动录音设备');
          }
        };

        stopBtn.onclick = async () => {
          if (!state.isRecording) return;
          
          state.isProcessing = true;
          const audioBlob = audioHandler.stopRecording();
          startBtn.disabled = false;
          stopBtn.disabled = true;
          
          if (!audioBlob) {
            updateUI('error', '录音失败');
            state.isProcessing = false;
            return;
          }

          try {
            updateUI('processing');
            
            const asrData = await APIService.performASR(audioBlob);
            const sentence = asrData.text || "No speech detected.";
            updateUI('success', sentence);

            const gecData = await APIService.performGEC(sentence);
            const feedback = gecData.choices?.[0]?.message?.content || "⚠️ No feedback returned.";

            const orig = feedback.match(/Original:\s*(.+)/i)?.[1] || "";
            correctedSentence = feedback.match(/Corrected:\s*(.+)/i)?.[1] || "";
            const errorType = feedback.match(/Error Type:\s*(.+)/i)?.[1] || "";
            const explanation = feedback.match(/Explanation.*?:\s*([\s\S]+)/i)?.[1] || "";

            const [hlOrig, hlCorr] = highlightDiff(orig, correctedSentence);
            gecResult.innerHTML = `
              <strong>Original:</strong> ${hlOrig}<br>
              <strong>Corrected:</strong> ${hlCorr}<br>
              <strong>Error Type:</strong> ${errorType}<br>
              <strong>Explanation:</strong> ${explanation.trim()}
            `;

            playTTS.disabled = false;
          } catch (error) {
            console.error('处理失败:', error);
            updateUI('error', error.message);
          } finally {
            state.isProcessing = false;
          }
        };

        playTTS.onclick = async () => {
          if (!correctedSentence || state.isProcessing) return;
          
          try {
            state.isProcessing = true;
            const audioBlob = await APIService.performTTS(correctedSentence);
            const audioURL = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioURL);
            await audio.play();
          } catch (error) {
            console.error('TTS失败:', error);
            alert("TTS failed: " + error.message);
          } finally {
            state.isProcessing = false;
          }
        };
      });
    </script>
  </body>
</html>
